{% extends "db/base.html" %}
{% block content %}

<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/backgrid.css" />
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/backgrid-paginator.css" />

<script type='text/javascript' src='{{ STATIC_URL }}js/underscore.js'></script>
<script type='text/javascript' src='{{ STATIC_URL }}js/backbone.js'></script>
<script type='text/javascript' src='{{ STATIC_URL }}js/backbone-pageable.js'></script>
<script type='text/javascript' src='{{ STATIC_URL }}js/backbone-tastypie.js'></script>
<script type='text/javascript' src='{{ STATIC_URL }}js/backgrid.js'></script>
<script type='text/javascript' src='{{ STATIC_URL }}js/backgrid-paginator.js'></script>

<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/DT_bootstrap2.css" />

<style type="text/css">
	@media screen{
		.table th, .table td {
			padding: 1px;
		}
	}	
</style>
	
<script type="text/javascript">

$(document).ready(function(){
	var _url_schema = '/db/api/v1/screensaveruser/schema/'; // TODO: how to use django url tag here
	var _url = '/db/api/v1/screensaveruser/?format=json'; // TODO: how to use django url tag here

	window.App = {
	    Models: {},
	    Collections: {},
	    Views: {},
	    Router: {}
	};
	
	App.Router = Backbone.Router.extend({
	    routes: {
	        '': 'index',
	        'page/:page': 'toPage',
	        'order_by/:orderBy(/page/:page)': 'toOrderedToPage'
	    },

	    index: function(){
	        console.log("Index route has been called..");
	    },	
	    toPage: function(page){
	    	// this is what hooks the URL read to the model action - sde
	    	console.log("toPage route: " + page);
	    	screensaverUsers.getPage(parseInt(page));
	    },
	    toOrderedToPage: function(orderBy,page){
	    	console.log("toOrderedToPage route: " + orderBy + ", page: " + page);
	    	var order = -1;
	    	var direction = 'ascending';
	    	if(orderBy.charAt(0) === '-'){
	    		order = 1; // according to the docs, 1 == descending 
	    		direction = 'descending';
	    		orderBy = orderBy.substring(1);
	    	}
	    	if(typeof page !== 'undefined'){
//	    		screensaverUsers.getPage(page);
		    	screensaverUsers.state.currentPage = parseInt(page);
	    	}
	    	

	    	// trigger the sort event to let the backgrid header cell know to change the sort indicator on the column
	    	// Note: the following two triggers fail to actually notify the header cell of the sort, not sure why, but 
	    	// perhaps it is not yet listening.
//			Backbone.PageableCollection.prototype.trigger(screensaverUsers,"backgrid:sort", orderBy, direction, null, screensaverUsers);
	    	// tell the pageable collection about it
//	    	screensaverUsers.setSorting(orderBy, order);
	    	screensaverUsers.state.sortKey = orderBy;
	    	screensaverUsers.state.order = order;
	    	screensaverUsers.fetch({reset: true});
			screensaverUsers.trigger("backgrid:sort", orderBy, direction, null, screensaverUsers);
			screensaverUsers.trigger("backgrid:refresh", orderBy, direction, null, screensaverUsers);

	    }
	
	});	
	router = new App.Router;
	var ScreensaverUser = Backbone.Model.extend({});
	var getOffset = function(){
		return 10;
	}
	var ScreensaverUsers = Backbone.PageableCollection.extend({
		model: ScreensaverUser,
		url: _url,
		state: {
			pageSize: 15,
			totalRecords: 2142
		},
		queryParams: { 
			// adjust the query params for tastypie
			pageSize: 'limit',
			offset: function(){
				return (this.state.currentPage-1) * this.state.pageSize;
			},
			totalRecords: null, // unset for tastypie
			totalPages: null, // unset for tastypie
			currentPage: null, // unset for tastypie
		    sortKey: "order_by", // modified for tastypie
		    order: null, // unset for tastypie
		    order_by: function() { // modified for tastypie: use only "order_by=(-)field_name"
		    	if (typeof this.state !== 'undefined' && this.state.sortKey && this.state.order) {
		    		var dir = "-";
		    		if (this.state.order<0){  // according to docs, -1 == ascending
		    			dir = "";
		    		} 
		    		return dir + this.state.sortKey;
		    	}
		    },
			
		},
		parse: function(response) { 
			// hack the response for tastypie: 
			// note, this is because the pageable collection doesn't work with the backbone-tastypie.js fix
      		return response.objects;
   		},
   		/**
	       @property {-1|0|1} [state.order=-1] The order to use for sorting. Specify
	       -1 for ascending order or 1 for descending order. If 0, no client side
	       sorting will be done and the order query parameter will not be sent to
   		 */
   		setSorting: function(sortKey,order,options) { // override and hack in sorting URL support
   			console.log('setSorting called: ' + sortKey+ ', order: ' + order + typeof(order) + ', options: ' + options );
   			
   			var dir = '-';
   			var direction = 'descending';
   			if(typeof order !== 'undefined' && order < 0){
   				dir = '';
   				direction = 'ascending';
   			}

   			if(this.state.currentPage !== null){
   				console.log('currentPage: ' + this.state.currentPage);
   				if (sortKey !== 'null'){
		   			router.navigate('/order_by/' + dir+ sortKey + '/page/'+ this.state.currentPage);
   				}else{
		   			router.navigate('/page/'+ this.state.currentPage);
   				}
   			}else{
   				if (sortKey !== null){
		   			router.navigate('/order_by/' + dir+ sortKey);
   				}else{
		   			router.navigate('/');
   				}
   			}
   			var obj = Backbone.PageableCollection.prototype.setSorting.call(this,sortKey, order);
   			//Backbone.PageableCollection.prototype.trigger(this,'backgrid:sort');
	    	// Backbone.PageableCollection.prototype.trigger(this,"backgrid:sort", sortKey, direction, null, this);
	    	return obj;

   			
   		},
   		getPage: function(page) { // override and hack in paging URL support
   			console.log('getPage called: ' + page);
   			page = parseInt(page);
   			if(this.state.sortKey !== null){
   				var sortKey = this.state.sortKey;
   				if(this.state.order > 0){
   					sortKey = '-' + sortKey;
   				}
   	   			router.navigate('order_by/' + sortKey +'/page/'+ page);
   			}else{
	   			router.navigate('/page/'+ page);
   			}
   			return Backbone.PageableCollection.prototype.getPage.call(this,page);
   		}
	});
	
	var screensaverUsers = new ScreensaverUsers();
	
	var allEvent = function(event){
		console.log("event fired: " + event);
	};
	screensaverUsers.on({
	  "all": allEvent,
	});

	Backbone.history || (Backbone.history = new Backbone.History());
	Backbone.history.start({
	  pushState: false,
	  root: '/db/screeners2/'
	});

	$.ajax({
		type: "GET",
       	url: _url_schema,
       	data: "",
       	dataType: "json",
       	success: function(result) {
       		var columns = iccbl.createBackgridColModel(result.fields);
			
			var grid = new Backgrid.Grid({
			  columns: columns,
			  collection: screensaverUsers
			});
			var exampleGrid = $("#example-table");
			// Render the grid and attach the root to your HTML document
			exampleGrid.append(grid.render().$el);

			// Initialize the paginator
			var paginator = new Backgrid.Extension.Paginator({
			  columns: columns,
			  collection: screensaverUsers
			});
			
			// Render the paginator
			exampleGrid.append(paginator.render().$el);
			
			// ServerSideFilter delegates the searching to the server by submitting a query.
			// var serverSideFilter = new Backgrid.Extension.ServerSideFilter({
			  // collection: screensaverUsers,
			  // name: "comments", // the name of the URL query parameter
			  // placeholder: "Search comments" // HTML5 placeholder for the search box
			// });
// 			
			// exampleGrid.append(serverSideFilter.render().$el);
			
			// Fetch some data from the url
			screensaverUsers.fetch({reset: true});
	   	}, // end success outer ajax call
		error: function(x, e) {
			alert(x.readyState + " "+ x.status +" "+ e.msg);
		}			
	});


});

</script>

<div class="container-fluid" style="margin-left: 0px; background-color: #c5d2db;">
	<div id="example-table"></div>
</div>
{% endblock %}
