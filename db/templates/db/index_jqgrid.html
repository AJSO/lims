{% extends "db/base.html" %}
{% block content %}

	<script src="{{ STATIC_URL }}/js/grid.locale-en.js" type="text/javascript"></script>
	<script src="{{ STATIC_URL }}/js/jquery.jqGrid.min.js" type="text/javascript"></script>

	<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css">
	<link rel="stylesheet" href="http://jqueryui.com/jquery-wp-content/themes/jquery/css/base.css?v=1">
	<link rel="stylesheet" href="http://jqueryui.com/jquery-wp-content/themes/jqueryui.com/style.css">
	<script type='text/javascript' src='http://code.jquery.com/ui/1.10.2/jquery-ui.js'></script>

	<link rel="stylesheet" type="text/css" media="screen" href="{{ STATIC_URL }}/css/ui.jqgrid.css" />
	<style>
	.ui-jqgrid .ui-jqgrid-bdiv {
		position: relative;
		margin: 0em;
		padding:0;
		/*overflow: auto;*/
		overflow-x:hidden;
		overflow-y:auto;
		text-align:left;
	}
	</style>

	<script type="text/javascript">
	$(document).ready(function(){
		var _width = $("#scrollable").width() ;

	//_url =  url 'dispatch_list' resource_name='screensaveruser' api_name='v1' %}
	var _url_schema = '/db/api/v1/screensaveruser/schema/'
	var _limit = 10;
	var _offset= 0;
	var _url = '/db/api/v1/screensaveruser/'; // TODO: how to use django url tag here
	$.ajax(
	    {
	       type: "GET",
	       url: _url_schema,
	       data: "",
	       dataType: "json",
	       success: function(result) {
			  	var _colModel = [];
			  	var i = 0;
			  	var _total_count = 0;
				for (var field in result.fields){
					i++;
				}


				var _colWidth = 1/i * _width;
				console.log('colWidth:' + _colWidth);
				i = 0;
				for (var field in result.fields){
					_colModel[i++] = { name: field, index: field, width: _colWidth }
				}


				// Follows is a modified instantiation to make django-tastypie json output and pagination work with jqGrid
				// specifically, converting: tastypie offset and limit to jqGrid page and rows variables (also rowNum setting)
				// also, jsonReader: converts the tastypie JSON to jqGrid format (root, cell values)
				$("#example").jqGrid({
				    datatype: 'json',
				    url: _url,
				    jsonReader: {
				    	//total pages
			    		total:  function (obj) {
			    			var val = Math.floor(obj.meta.total_count/obj.meta.limit + 1);
		    				_total_count = obj.meta.total_count;
			    			console.log('pages:'+ val);
			    			return val;
		    			},
			    		//current page
			    		page: function (obj) {
			    			//_offset = obj.meta.offset + _limit;
			    			var val = Math.floor(obj.meta.offset/obj.meta.limit +1);
			    			console.log('page: ' + val);
			    			return val;
			    		},
			    		records: 'meta.total_count',
			    		root: 'objects',
			    		cell: function (obj) {
			    			var cell = [];
			    			var i=0; for (var field in obj){ cell[i++] = obj[field]; }
			    			return cell;
			    		},
			    		id: 'screensaver_user_id'
				    },
				    //prmNames: {rows: 'limit', page: 'offset'},
				    // post the right params for tastypie: offset, limit; jqGrid: page, rows
				    postData: { 
				    	'limit': function() {
				    		return $("#example").getGridParam('rowNum');
				    	},
				    	'offset': function () { return _offset; }
				    },
				    // More customization for tastypie:
				    // event handling on each click on the paging toolbar; need to convert "rowNum" to tastypie "offset",
				    // also, need to grab the user input "page" field, if it has been set by the user, and convert to tastypie "offset".
				    onPaging: function(pgButton) {
				    	var rowNum = $("#example").getGridParam('rowNum');
						console.log('paging clicked: ' + JSON.stringify(pgButton) + ', rowNum: ' + rowNum );
						if (pgButton === 'next_pager'){
							_offset += rowNum;
						} else if (pgButton === 'prev_pager'){
							_offset -= rowNum;
							if (_offset < 0 ) _offset = 0;
						} else if (pgButton === 'last_pager'){
							_offset = Math.floor(_total_count/rowNum)*rowNum;
						} else if (pgButton === 'first_pager'){
							_offset = 0;
						} else if (pgButton == 'user'){
					    	// sadly, this doesn't work: var page = $("#example").getGridParam('page');
					    	// so have to query the dom: less specific: var page = $(".ui-pg-input").val();
					    	var page = $($("#example").jqGrid("getGridParam", "pager") + " .ui-pg-input").val();
							_offset = (page-1) * rowNum;
						}
				 	},
				    colModel:_colModel,
				    //TODO: colNames: _colModel,
				    pager: '#pager',
				    rowNum:30,
				    rowList:[10,30,50,100,500],
				    forceFit: false,
				    sortname: 'screensaver_user_id',
				    sortorder: 'desc',
				    viewrecords: true,
				    gridview: false,
				    caption: 'Users',
				    shrinkToFit: false,
				    viewsortcols : [false,'vertical',true],
				    width: '100%',
		        	height: '100%'
	        	});


	       },
	       error: function(x, e) {
	            alert(x.readyState + " "+ x.status +" "+ e.msg);
	       }
	    });

	});

	////  auto search stuff below - not done!

  	var timeoutHnd;
	var flAuto = true;

	function doSearch(ev){
		if(!flAuto)
			return;
	//	var elem = ev.target||ev.srcElement;
		if(timeoutHnd)
			clearTimeout(timeoutHnd)
		timeoutHnd = setTimeout(gridReload,500)
	};

	function gridReload(){
		var search_val = jQuery("#search_val").val();
		jQuery("#example").jqGrid('setGridParam',{url:"{{ request.get_full_path }}search/?search="+search_val,page:1}).trigger("reloadGrid");
	};
	function enableAutosubmit(state){
		flAuto = state;
		jQuery("#submitButton").attr("disabled",state);
	};
</script>
<div id="scrollable">
	<div>
		Search:<br />
		<input type="text" id="search_val" onkeydown="doSearch(arguments[0]||event)" />
	</div>
	<div class="jqGridUI">
		<table id="example" cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered" >
		</table>
		<div id="pager"></div>
	</div>
</div>

{% endblock %}

